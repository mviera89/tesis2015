<html xmlns:h="http://java.sun.com/jsf/html"
	  xmlns:ui="http://java.sun.com/jsf/facelets"
	  xmlns:f="http://java.sun.com/jsf/core"
	  xmlns:p="http://primefaces.org/ui"
      xmlns:a4j="http://richfaces.org/a4j">
	
	<style type="text/css">
	    .column1{width: 20%; height:auto}
		.column2{width: 80%; height:auto}
	</style>

	<h3 style="margin-top:1%">Adaptar modelo</h3>
	
	<h:form id="adaptar_form">
	  <p:tabView>	
	    <p:tab title="Modelo">
		<div style="text-align: right; padding-bottom: 0.3em; ">
			<p:commandButton value="Vista previa" action="#{adaptarModeloBean.mostrarVistaPrevia()}" update=":panel_principal" />
		</div>
		<div style="padding-bottom: 0.3em;">
			<p:diagram value="#{adaptarModeloBean.modelo}" style="height: 400px;" styleClass="ui-widget-content" var="elem">
				<f:facet name="element">
					<h:commandLink disabled="#{!elem.esPV}" onclick="#{adaptarModeloBean.seleccionarVariantes()};"
								   value="#{elem.nombre}" title="#{elem.esPV ? 'Seleccionar variantes' : ''}" style="color: #{elem.color}">
						<div style="position: relative; display:block; margin:auto; width: 32px;">
							<h:commandLink disabled="#{elem.hijos.size() == 0}" >
								<p:graphicImage value="/imagenes/#{elem.imagen}" style="display:block; margin:auto;" />
								<p:graphicImage value="/iconos/mas.png" style="position: absolute; top: 20px; left: 20px;" 
												rendered="#{adaptarModeloBean.elementoTieneHijos(elem.elementID) and !elem.estaExpandido}" title="Haga click para ver los hijos de este elemento."/>
								<p:graphicImage value="/iconos/menos.png" style="position: absolute; top: 20px; left: 20px;" 
												rendered="#{adaptarModeloBean.elementoTieneHijos(elem.elementID) and elem.estaExpandido}" title="Haga click para ocultar los hijos de este elemento."/>
								<p:outputLabel value="#{elem.etiqueta}" style="position: absolute; top: -5px; left: 20px;"/>
								<p:ajax event="click" listener="#{adaptarModeloBean.redibujarHijos}" update=":panel_principal"/>
								<f:param name="elemSeleccionado" value="#{elem.elementID}"/>
							</h:commandLink>
						</div>
						<p:ajax update=":panel_principal"/>
						<f:param name="elemSeleccionado" value="#{elem.elementID}"/>
					</h:commandLink>
				</f:facet>
			</p:diagram>
		</div>
	    </p:tab>
	    <p:tab title="Roles-Tareas">
	    	<div style="padding-bottom: 0.3em;">
			<p:diagram value="#{adaptarModeloBean.modeloRolesTareas}" style="height: 400px;" styleClass="ui-widget-content" var="elem">
				<f:facet name="element">
					<h:commandLink disabled="#{!elem.esPV}" onclick="#{adaptarModeloBean.seleccionarVariantes()};"
								   value="#{elem.nombre}" title="#{elem.esPV ? 'Seleccionar variantes' : ''}" style="color: #{elem.color}">
						<div style="position: relative; display:block; margin:auto; width: 32px;">
							<h:commandLink disabled="#{elem.hijos.size() == 0}" >
								<p:graphicImage value="/imagenes/#{elem.imagen}" style="display:block; margin:auto;" />
								<p:graphicImage value="/iconos/mas.png" style="position: absolute; top: 20px; left: 20px;" 
												rendered="#{adaptarModeloBean.elementoTieneHijos(elem.elementID) and !elem.estaExpandido}" title="Haga click para ver los hijos de este elemento."/>
								<p:graphicImage value="/iconos/menos.png" style="position: absolute; top: 20px; left: 20px;" 
												rendered="#{adaptarModeloBean.elementoTieneHijos(elem.elementID) and elem.estaExpandido}" title="Haga click para ocultar los hijos de este elemento."/>
								<p:outputLabel value="#{elem.etiqueta}" style="position: absolute; top: -5px; left: 20px;"/>
								<p:ajax event="click" listener="#{adaptarModeloBean.redibujarHijos}" update=":panel_principal"/>
								<f:param name="elemSeleccionado" value="#{elem.elementID}"/>
							</h:commandLink>
						</div>
						<p:ajax update=":panel_principal"/>
						<f:param name="elemSeleccionado" value="#{elem.elementID}"/>
					</h:commandLink>
				</f:facet>		
			</p:diagram>
		</div>
	    </p:tab>
	    <p:tab title="Roles-WorkProducts">
	    	
	    	<p:accordionPanel value="#{adaptarModeloBean.rolesTareas}" var="rolTarea">
		        <p:tab>
		        	<!-- Muestro el nombre del rol en el encabezado -->
		        	<f:facet name="title">
					   <h:graphicImage value="/imagenes/#{rolTarea.rol.imagen}" />
		               <h:outputText value="#{rolTarea.rol.nombre}"/>
		            </f:facet>
		            
		        	<h:panelGrid columns="2" columnClasses="column1, column2" style="width: 100%;">
			            
			            <h:panelGroup>
			               <h:commandLink disabled="#{!rolTarea.rol.esPV}" onclick="#{adaptarModeloBean.seleccionarVariantes()};"
										  value="#{rolTarea.rol.nombre}" title="#{rolTarea.rol.esPV ? 'Seleccionar variantes' : ''}" style="color: #{rolTarea.rol.color}; position: absolute; left: 8%;">
								<p:graphicImage value="/imagenes/#{rolTarea.rol.imagen}" style="display:block; margin:auto;" />
								<p:ajax update=":panel_principal"/>
								<f:param name="elemSeleccionado" value="#{rolTarea.rol.elementID}"/>
							</h:commandLink>
						</h:panelGroup>
						
		               	<h:panelGroup>
		               		
		               		<p:fieldset style="margin-bottom:20px">
		               			<legend>Realiza</legend>
					            <!-- Muestro las tareas primarias del rol -->
					            <p:diagram value="#{rolTarea.primary}" style="height: 100px;" var="elem">
									<f:facet name="element">
										<h:panelGroup rendered="#{elem.type.toString() != 'vpRoleDescriptor' and elem.type.toString() != 'RoleDescriptor'}">
											<h:commandLink disabled="#{!elem.esPV}" onclick="#{adaptarModeloBean.seleccionarVariantes()};"
														   value="#{elem.nombre}" title="#{elem.esPV ? 'Seleccionar variantes' : ''}" style="color: #{elem.color};">
												<p:graphicImage value="/imagenes/#{elem.imagen}" style="display:block; margin:auto;" />
												<p:ajax update=":panel_principal"/>
												<f:param name="elemSeleccionado" value="#{elem.elementID}"/>
											</h:commandLink>
										</h:panelGroup>
									</f:facet>
								</p:diagram>
							</p:fieldset>
							
		               		<p:fieldset style="margin-bottom:20px">
		               			<legend>Realiza además</legend>
								<!-- Muestro las tareas adicionales del rol -->
					            <p:diagram value="#{rolTarea.additionally}" style="height: 100px;" var="elem">
									<f:facet name="element">
										<h:panelGroup rendered="#{elem.type.toString() != 'vpRoleDescriptor' and elem.type.toString() != 'RoleDescriptor'}">
											<h:commandLink disabled="#{!elem.esPV}" onclick="#{adaptarModeloBean.seleccionarVariantes()};"
														   value="#{elem.nombre}" title="#{elem.esPV ? 'Seleccionar variantes' : ''}" style="color: #{elem.color};">
												<p:graphicImage value="/imagenes/#{elem.imagen}" style="display:block; margin:auto;" />
												<p:ajax update=":panel_principal"/>
												<f:param name="elemSeleccionado" value="#{elem.elementID}"/>
											</h:commandLink>
										</h:panelGroup>
									</f:facet>		
								</p:diagram>
							</p:fieldset>
							
						</h:panelGroup>
						
		        	</h:panelGrid>
		        </p:tab>
		    </p:accordionPanel>
	    </p:tab>
	    <p:tab title="Tareas-WorkProducts">
	    </p:tab>
	  </p:tabView>
		<p:commandButton value="Finalizar" rendered="#{adaptarModeloBean.erroresModeloFinal.size() == 0}" update=":panel_principal"
					 	 actionListener="#{exportarModeloBean.exportarModelo(adaptarModeloBean.modeloAdaptado)}"
					 	 action="#{VistaBean.actualizarIndiceActivo(2)}" />
		<p:commandButton value="Finalizar" rendered="#{adaptarModeloBean.erroresModeloFinal.size() > 0}"
						 onclick="PF('erroresDialog').show(); return false;" />
	</h:form>
	
	<p:dialog header="Seleccionar variantes" widgetVar="variantesDialog" modal="true" dynamic="true" closeOnEscape="true" 
			  style="min-width: 25%; ">
		<h:form id="seleccionarVariante_form">
			<p:selectManyCheckbox id="variantesCheck" value="#{adaptarModeloBean.variantesSeleccionadas}" layout="grid" columns="1" 
								  style="margin-bottom: 5%;">
				<f:selectItems value="#{adaptarModeloBean.variantes}" var="var" itemLabel="#{var.label}" itemValue="#{var.value}" />
			</p:selectManyCheckbox>
			<p:messages id="msg" showDetail="true"/>
			<p:commandButton value="Seleccionar" update="msg" />
			<p:commandButton value="Cancelar" immediate="true" update=":panel_principal" />
		</h:form>
	</p:dialog>
	
	<p:dialog header="Vista previa" widgetVar="vistaPreviaDialog" modal="true" dynamic="true" closeOnEscape="true" style="min-width: 50%; ">
		<div style="height:400px" >
			<p:diagram value="#{adaptarModeloBean.modeloAdaptado}" style="height:95%" styleClass="ui-widget-content" var="elem">
				<f:facet name="element">
					<p:graphicImage value="/imagenes/#{elem.imagen}" style="display:block; margin:auto;"/>
					<p:outputLabel value="#{elem.etiqueta}" style="position: absolute; top: -5px; left: 20px;"/>
					<p:outputLabel value="#{elem.nombre}" />
				</f:facet>
			</p:diagram>
			<br/>
		 </div>
	</p:dialog>
	
	<p:dialog header="Adaptar modelo" widgetVar="erroresDialog" modal="true" dynamic="true" closeOnEscape="true" style="min-width: 25%; ">
		<h:form id="erroresDialog_form">
			<p:outputLabel value="No es posible finalizar la adaptación del modeo debido a los siguientes errores:" />
			<ui:repeat var="error" value="#{adaptarModeloBean.erroresModeloFinal}"> 
			   <li><b>#{error[0]}: </b>#{error[1]}</li>
			</ui:repeat>
			<br/>
			<p:commandButton value="Cerrar" immediate="true" update=":panel_principal" />
		</h:form>
	</p:dialog>
	
</html>